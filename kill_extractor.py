import cv2,pytesseract,json,os;from moviepy.editor import VideoFileClip,concatenate_videoclips;volume_path='/videos';config_path=os.path.join(volume_path,'config.json');status_path=os.path.join(volume_path,'status.json');video_path=os.path.join(volume_path,'cut.mp4');output_path=os.path.join(volume_path,'kill_cut.mp4');if not os.path.exists(config_path):print(f'❌ config.json fehlt unter: {config_path}');exit();with open(config_path,encoding='utf-8-sig') as f:cfg=json.load(f);name=cfg.get('nickname','Eangelus');pre=cfg.get('pre_seconds',10);post=cfg.get('post_seconds',10);if not os.path.exists(video_path):print(f'❌ cut.mp4 nicht gefunden unter: {video_path}');exit();clip=VideoFileClip(video_path);duration=clip.duration;timestamps=[];cap=cv2.VideoCapture(video_path);total=int(cap.get(cv2.CAP_PROP_FRAME_COUNT));count=0;while cap.isOpened():ret,frame=cap.read();if not ret:break;count+=1;if count%10!=0:continue;sec=cap.get(cv2.CAP_PROP_POS_MSEC)/1000;crop=frame[0:50,-250:];try:text=pytesseract.image_to_string(crop,timeout=2);except RuntimeError:continue;if count%500==0:print(f'⏳ Fortschritt: Frame {count} von {total}');with open(status_path,'w') as s:json.dump({'progress':round(count/total*100,2),'message':f'Scanne Frame {count} von {total}','clips_found':len(timestamps)},s);if name in text:print(f'✅ Kill erkannt bei Sekunde {round(sec,2)}');start,end=max(sec-pre,0),min(sec+post,duration);if timestamps and start<=timestamps[-1][1]:timestamps[-1]=(timestamps[-1][0],max(end,timestamps[-1][1]));else:timestamps.append((start,end));cap.release();if timestamps:clips=[clip.subclip(s,e) for s,e in timestamps];concatenate_videoclips(clips).write_videofile(output_path,codec='libx264',audio_codec='aac');print(f'✅ Fertig! Geschnittenes Video gespeichert unter: {output_path}');else:print('⚠️ Keine Kills erkannt. Es wurde kein Video erstellt.')
